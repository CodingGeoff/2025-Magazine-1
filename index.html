<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Free Magazine Archive</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" />
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    /* 全局样式 */
    body {
      font-family: "Montserrat", sans-serif;
      background: linear-gradient(135deg, #f4f4f9 0%, #e0e0e9 100%);
      padding: 20px;
      margin: 0;
      background-image: url("https://www.transparenttextures.com/patterns/cubes.png");
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    h1 {
      font-size: 3.5rem;
      font-weight: 800;
      color: #2c3e50;
      margin-bottom: 1rem;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      animation: fadeInDown 1s ease-out;
    }

    h1::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, #3498db, #2980b9);
      border-radius: 2px;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .search-container {
      margin-bottom: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      max-width: 600px;
    }

    .search-input {
      width: 100%;
      padding: 15px 20px;
      font-size: 1rem;
      border: 2px solid #3498db;
      border-radius: 25px;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .search-input:focus {
      border-color: #2980b9;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    ul {
      list-style-type: none;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      width: 90%;
    }

    li {
      perspective: 1000px;
    }

    a {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background-color: #ffffff;
      color: #333;
      text-decoration: none;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
    }

    a::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    a:hover {
      transform: translateY(-10px) scale(1.05) rotateX(10deg);
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.2);
      background: linear-gradient(to bottom right, #3498db, #2980b9);
      color: white;
    }

    a:hover::before {
      opacity: 1;
    }

    .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      transition: color 0.3s ease;
    }

    a:hover .icon {
      color: white;
    }

    .title {
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .upload-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .custom-file-label {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin-bottom: 15px;
    }

    #fileinp {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    #btn {
      background-color: #2ecc71;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 18px;
      font-family: "Montserrat", sans-serif;
    }

    #btn:hover {
      background-color: #27ae60;
    }

    .upload-form input[type="submit"] {
      background-color: #3498db;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 18px;
      font-family: "Montserrat", sans-serif;
    }

    .upload-form input[type="submit"]:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .key-container {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    .key-option {
      background-color: #f0f0f0;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .key-option:hover {
      background-color: #e0e0e0;
    }

    .key-option.selected {
      background-color: #3498db;
      color: white;
    }

    /* 新增样式 */
    .pdf-link::after {
      content: attr(data-file-count);
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(52, 152, 219, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.5rem;
      }

      .search-container {
        max-width: 90%;
      }

      ul {
        grid-template-columns: 1fr;
      }

      .pdf-link::after {
        top: 10px;
        right: 10px;
        font-size: 0.7rem;
      }
    }
  </style>
</head>

<body>
  <h1>Archive</h1>
  <div class="search-container">
    <input type="text" id="search-input" class="search-input" placeholder="Search for a magazine..." />
  </div>
  <ul id="pdf-list"></ul>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
  <script>
    // 静态定义PDF文件列表
    const pdfFiles = [
      "Artforum 02 2025.pdf",
      "Canadian Living 03 2025.pdf",
      "Computeractive 12 02 2025.pdf",
      "FORTUNE EU 02 03 2025.pdf",
      "Ideal Home UK 03 2025§§§§1.pdf",
      "Ideal Home UK 03 2025§§§§2.pdf",
      "Ideal Home UK 03 2025§§§§3.pdf",
      "Kitchen Bath Design News 01 02 2025.pdf",
      "Model Airplane News 03 04 2025.pdf",
      "Sports Illustrated National Champions Commemorative 2025.pdf",
    ];

    // 文件分组逻辑
    function groupFiles(files) {
      const groups = {};
      files.forEach((file) => {
        const baseName = file.split("§§§§")[0].replace(/\.pdf$/, "");
        if (!groups[baseName]) {
          groups[baseName] = [];
        }
        groups[baseName].push(file);
      });
      return groups;
    }

    // 生成列表项
    function renderPDFList() {
      const pdfList = document.getElementById("pdf-list");
      const fileGroups = groupFiles(pdfFiles);

      Object.entries(fileGroups).forEach(([baseName, files]) => {
        const li = document.createElement("li");
        const link = document.createElement("a");

        // 设置链接属性
        link.href = `./static/uploads/${files[0]}`;
        link.className = "pdf-link";
        link.dataset.files = files.join(",");
        link.dataset.base = baseName;
        link.dataset.fileCount = `${files.length} part${files.length > 1 ? "s" : ""
          }`;

        // 创建图标
        const icon = document.createElement("i");
        icon.className = getFileIconClass(files[0]);
        icon.style.color = getFileIconColor(files[0]);
        icon.classList.add("icon");

        // 创建标题
        const title = document.createElement("span");
        title.className = "title";
        title.textContent = baseName;

        // 组装元素
        link.appendChild(icon);
        link.appendChild(title);
        li.appendChild(link);
        pdfList.appendChild(li);
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById("search-input");
      const urlParams = new URLSearchParams(window.location.search);
      const searchQuery = urlParams.get("search") || "";
      searchInput.value = searchQuery;

      // 搜索功能
      searchInput.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll("#pdf-list .title").forEach((title) => {
          const item = title.closest("li");
          if (title.textContent.toLowerCase().includes(query)) {
            item.style.display = "block";
          } else {
            item.style.display = "none";
          }
        });
      });

      renderPDFList();

      // 新增：获取文件大小的函数
      async function getFileSize(url) {
        try {
          const response = await fetch(url, { method: 'HEAD' });
          if (!response.ok) throw new Error('Failed to get file size');
          const size = response.headers.get('Content-Length');
          return parseInt(size, 10) || 0;
        } catch (error) {
          console.error('Error getting file size:', error);
          return 0;
        }
      }

      // 修改后的点击处理函数
      document.getElementById("pdf-list").addEventListener("click", async (e) => {
        const link = e.target.closest(".pdf-link");
        if (!link) return;
        e.preventDefault();

        const files = link.dataset.files.split(",");
        const baseName = link.dataset.base;

        try {
          const { PDFDocument } = PDFLib;
          const mergedPdf = await PDFDocument.create();
          let validFiles = [];
          let loadedCount = 0;

          // 显示进度条弹窗
          const progressSwal = Swal.fire({
            title: 'Loading PDF',
            html: `
          <div style="width: 80%; margin: 0 auto;">
            <div class="progress-container" style="height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
              <div class="progress-bar" style="height: 100%; width: 0%; background: #3498db; transition: width 0.3s ease;"></div>
            </div>
            <div class="progress-text" style="margin-top: 10px; text-align: center; color: #666;"></div>
          </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
              updateProgress(0, files.length);
            }
          });

          // 更新进度条函数
          function updateProgress(current, total) {
            const percent = (current / total) * 100;
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressText) progressText.textContent =
              `Loading ${current} of ${total} parts (${Math.round(percent)}%)`;
          }

          // 获取所有文件大小并计算超时时间
          const fileDetails = await Promise.all(files.map(async (file) => {
            const url = `./static/uploads/${file}`;
            const size = await getFileSize(url);
            // 计算动态超时：每MB 2秒 + 基础5秒
            const timeout = Math.max(Math.round((size / (1024 * 1024)) * 2000) + 5000, 10000);
            return { file, timeout };
          }));

          // 加载文件函数（带动态超时）
          const loadWithTimeout = async (file, timeout) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
              const pdfUrl = `./static/uploads/${file}`;
              const response = await fetch(pdfUrl, { signal: controller.signal });
              if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

              const pdfBytes = await response.arrayBuffer();
              const header = new Uint8Array(pdfBytes.slice(0, 5));
              if (String.fromCharCode(...header) !== "%PDF-") {
                throw new Error("Invalid PDF format");
              }

              const pdfDoc = await PDFDocument.load(pdfBytes);
              const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
              pages.forEach(page => mergedPdf.addPage(page));
              validFiles.push(file);
              return true;
            } catch (error) {
              if (error.name === 'AbortError') {
                console.warn(`Timeout loading ${file} after ${timeout}ms`);
              } else {
                console.error(`Error loading ${file}:`, error);
              }
              return false;
            } finally {
              clearTimeout(timeoutId);
              loadedCount++;
              updateProgress(loadedCount, files.length);
            }
          };

          // 顺序加载文件
          for (const { file, timeout } of fileDetails) {
            const success = await loadWithTimeout(file, timeout);
            if (!success && validFiles.length === 0) {
              throw new Error("Failed to load any valid PDF files");
            }
          }

          // 合并并保存PDF
          const mergedPdfBytes = await mergedPdf.save();
          const blob = new Blob([mergedPdfBytes], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);

          await progressSwal.close();
          window.open(url, "_blank").document.title = baseName;

        } catch (error) {
          console.error("Merge error:", error);
          Swal.fire({
            icon: "error",
            title: "Load Failed",
            text: error.message || "An error occurred during loading.",
            confirmButtonColor: "#3498db",
          });
        }
      });


      function handleFileSelection() {
        const fileInput = document.getElementById("fileinp");
        const keyContainer = document.getElementById("keyContainer");
        const uploadButton = document.querySelector('input[type="submit"]');

        if (fileInput.files && fileInput.files.length > 0) {
          keyContainer.style.display = "flex";
          const keys = JSON.parse("{{ keys | tojson }}");
          keyContainer.innerHTML = "";
          keys.forEach((key) => {
            const keyOption = document.createElement("div");
            keyOption.classList.add("key-option");
            keyOption.textContent = key;
            keyOption.addEventListener("click", function () {
              const selected = document.querySelector(".key-option.selected");
              if (selected) {
                selected.classList.remove("selected");
              }
              this.classList.add("selected");
              document.getElementById("selectedKey").value = this.textContent;
              if (
                fileInput.files &&
                fileInput.files.length > 0 &&
                document.getElementById("selectedKey").value
              ) {
                uploadButton.disabled = false;
              }
            });
            keyContainer.appendChild(keyOption);
          });
        } else {
          keyContainer.style.display = "none";
          uploadButton.disabled = true;
          document.getElementById("selectedKey").value = "";
        }
      }

      const uploadForm = document.getElementById("uploadForm");
      uploadForm.addEventListener("submit", function (e) {
        const selectedKey = document.getElementById("selectedKey").value;
        if (!selectedKey) {
          e.preventDefault();
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Please select a key.",
            confirmButtonColor: "#3498db",
          });
        }
      });

      // 图标处理函数
      function getFileIconClass(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        return (
          {
            pdf: "fa-solid fa-file-pdf",
            docx: "fa-solid fa-file-word",
            xlsx: "fa-solid fa-file-excel",
            pptx: "fa-solid fa-file-powerpoint",
          }[ext] || "fa-solid fa-file"
        );
      }

      function getFileIconColor(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        return (
          {
            pdf: "#e74c3c",
            docx: "#2ecc71",
            xlsx: "#f1c40f",
            pptx: "#3498db",
          }[ext] || "#95a5a6"
        );
      }
    });
    
  </script>
</body>

</html>